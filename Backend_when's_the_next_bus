const express = require('express');
const {google} = require('googleapis');

const app = express();

app.get('/', async(req, res) => {
    // getting current time. return value is of the format "weekday, month date, hh:mm AM/PM". eg: "Sat, Feb 17, 01:08 AM"
    const currentTimeFull = new Date().toLocaleString('en-US', {
        weekday: 'short',
        hour : '2-digit',
        minute : '2-digit',
        day : '2-digit',
        month: 'short'
    })

    // logs current time
    console.log(`Time is ${currentTimeFull}`)

    const auth = new google.auth.GoogleAuth({
        keyFile:"credentials.json",
        scopes:"https://www.googleapis.com/auth/spreadsheets"
    })

    const client = await  auth.getClient();

    const googleSheets = google.sheets({ version: "v4", auth: client });

    const spreadsheetId = "1xe6YfuuSxe_1a0kM0U7fRPE364A39oOZys6aoFHHk9w";

    const metaData = await googleSheets.spreadsheets.get({
        auth,
        spreadsheetId,
    });

    const getRows = await googleSheets.spreadsheets.values.get({
    auth,
    spreadsheetId,
    range: "Sheet1",
    });  

    // array containing row-wise data from index 1 to end (not starting from 0 as 1st row is headers)
    const rowData = getRows.data.values.slice(1)

    const currentTime = currentTimeFull.split(', ')[2]
    
    res.send('hello')
    console.log(`The next bus to Nila: ${nextBusToNila(rowData, currentTime)} \nThe next bus to Sahyadri: ${nextBusToSahyadri(rowData, currentTime)}`)
})

app.listen(5000)

// takes row-wise data and current time as arguments and returns the next bus to nila timing
// checks first if end point is nila, then checks if that row's time value is greater than current time
function nextBusToNila(rowsDataNila, compareTimeValue) {
    for (val in rowsDataNila) {
        if (rowsDataNila[val][2].toLowerCase() === 'nila') {
            if (compareTime(strToTime(rowsDataNila[val][0]), strToTime(compareTimeValue))) {
                return rowsDataNila[val][0]
            }
        }   
    }
}

// takes row-wise data and current time as arguments and returns the next bus to sahyadri timing. Can i combine this and nila func into one? will it make any difference?  
function nextBusToSahyadri(rowsData, compareTimeValue) {
    for (val in rowsData) {
        if (rowsData[val][2].toLowerCase() === 'sahyadri') {
            if (compareTime(strToTime(rowsData[val][0]), strToTime(compareTimeValue))) {
                return rowsData[val][0]
            }
        }   
    }
}

function rowDataSelector(rowsData, currDateTime) {
    const instiHolidays = ['Jan 15', 'Jan 26', 'Mar 25', 'Mar 29', 'Apr 11', 'Apr 21']
    const MonFri = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']
    const currDate = currDateTime.split(', ')[1]
    let dayIndex

    // if date is a institute holiday go to saturday timetable
    if (instiHolidays.includes(currDate) && currDateTime.split(', ')[0] !== 'Sun') {
        dayIndex = "Sat"
    } else {
        dayIndex = currDateTime.split(', ')[0]
    }
    
    if (MonFri.includes(dayIndex)) {
        dayIndex = "Mon-Fri"
    }

    let startIndex = -1
    let endIndex
    for (row in rowsData) {
        if (rowsData[row][4] === dayIndex) {
            if (startIndex === -1) {
                startIndex = parseInt(row)
                endIndex = parseInt(row) + 1
            } else {
                endIndex = parseInt(row) + 1
            }
        }
    }
    return rowsData.slice(startIndex, endIndex)
}

// takes timestring ('8:00 am') and returns [8,0], if time is in PM adds 12 to hour value
function strToTime(strng) {
    const preString = strng.split(' ')
    let newStr
    //console.log(preString[1])
    if (preString[1].toUpperCase() === 'AM' && Number(preString[0].split(':')[0]) === 12) {
        newStr = [Number(0), Number(preString[0].split(':')[1])]
    } else if (preString[1].toUpperCase() === 'AM') {
        newStr = [Number(preString[0].split(':')[0]), Number(preString[0].split(':')[1])]
    } else if (preString[1].toUpperCase() === 'PM' && Number(preString[0].split(':')[0]) === 12) {
        newStr = [Number(preString[0].split(':')[0]), Number(preString[0].split(':')[1])]
    } else if (preString[1].toUpperCase() === 'PM') {
        newStr = [Number(preString[0].split(':')[0]) + 12, Number(preString[0].split(':')[1])]
    }
    return newStr
}

// returns 1 if time1 > time2, need to handle next day error
function compareTime(time1, time2) {
    if (time1[0] > time2[0]) {
        return 1
    } else if (time1[0] === time2[0]) {
        if (time1[1] >= time2[1]) {
            return 1
        } else {return 0}
    } else {return 0}
}
